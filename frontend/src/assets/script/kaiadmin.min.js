"use strict";

// Store logo header content for later use
var logoHeaderContent = $(".sidebar .logo-header").html();

// Function to apply layout colors based on the background color attribute
function layoutsColors() {
    if ($(".sidebar").is("[data-background-color]")) {
        $("html").addClass("sidebar-color");
    } else {
        $("html").removeClass("sidebar-color");
    }
}

// Function to apply custom background color or image
function customBackgroundColor() {
    $('*[data-background-color="custom"]').each(function() {
        if ($(this).is("[custom-color]")) {
            $(this).css("background", $(this).attr("custom-color"));
        } else if ($(this).is("[custom-background]")) {
            $(this).css("background-image", "url(" + $(this).attr("custom-background") + ")");
        }
    });
}

// Function for handling chart legend item click event
function legendClickCallback(e) {
    var target = e.target || e.srcElement;
    while (target.nodeName !== "LI") {
        target = target.parentElement;
    }

    var chartElement = target.parentElement;
    var chartIndex = parseInt(chartElement.classList[0].split("-")[0], 10);
    var chart = Chart.instances[chartIndex];
    var legendIndex = Array.prototype.slice.call(chartElement.children).indexOf(target);

    chart.legend.options.onClick.call(chart, e, chart.legend.legendItems[legendIndex]);

    if (chart.isDatasetVisible(legendIndex)) {
        target.classList.remove("hidden");
    } else {
        target.classList.add("hidden");
    }
}

// Function to handle file input and display image preview
function readURL(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(event) {
            $(input).parent(".input-file-image").find(".img-upload-preview").attr("src", event.target.result);
        };
        reader.readAsDataURL(input.files[0]);
    }
}

// Function to toggle password visibility
function showPassword(input) {
    var passwordField = $(input).parent().find("input");
    if (passwordField.attr("type") === "password") {
        passwordField.attr("type", "text");
    } else {
        passwordField.attr("type", "password");
    }
}

// Initialize logo header content
$(".main-header .logo-header").html(logoHeaderContent);

// Add focus and blur effects to search input field
$(".nav-search .input-group > input").focus(function() {
    $(this).parents().eq(2).addClass("focus");
}).blur(function() {
    $(this).parents().eq(2).removeClass("focus");
});

// Initialize tooltips and popovers
$(function() {
    let tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    [...tooltips].map(el => new bootstrap.Tooltip(el));

    let popovers = document.querySelectorAll('[data-bs-toggle="popover"]');
    [...popovers].map(el => new bootstrap.Popover(el));

    layoutsColors();
    customBackgroundColor();
});

// Card refresh animation
$(".btn-refresh-card").on("click", function() {
    var card = $(this).parents(".card");
    if (card.length) {
        card.addClass("is-loading");
        setTimeout(function() {
            card.removeClass("is-loading");
        }, 3000);
    }
});

// Initialize scrollbars for various elements
$(document).ready(function() {
    var elements = [
        ".sidebar .scrollbar",
        ".main-panel .content-scroll",
        ".messages-scroll",
        ".tasks-scroll",
        ".quick-scroll",
        ".message-notif-scroll",
        ".notif-scroll",
        ".quick-actions-scroll",
        ".dropdown-user-scroll"
    ];

    elements.forEach(function(selector) {
        var element = $(selector);
        if (element.length > 0) {
            element.scrollbar();
        }
    });

    // Focus on search input when search nav is shown
    $("#search-nav").on("shown.bs.collapse", function() {
        $(".nav-search .form-control").focus();
    });

    // Event handler for the sidenav toggler
    var sidenavToggler = $(".sidenav-toggler");
    sidenavToggler.on("click", function() {
        var isNavOpen = $("html").hasClass("nav_open");
        if (isNavOpen) {
            $("html").removeClass("nav_open");
            sidenavToggler.removeClass("toggled");
        } else {
            $("html").addClass("nav_open");
            sidenavToggler.addClass("toggled");
        }
    });

    // Event handler for quick sidebar toggler
    var quickSidebarToggler = $(".quick-sidebar-toggler");
    quickSidebarToggler.on("click", function() {
        var isQuickSidebarOpen = $("html").hasClass("quick_sidebar_open");
        if (isQuickSidebarOpen) {
            $("html").removeClass("quick_sidebar_open");
            $(".quick-sidebar-overlay").remove();
            quickSidebarToggler.removeClass("toggled");
        } else {
            $("html").addClass("quick_sidebar_open");
            quickSidebarToggler.addClass("toggled");
            $('<div class="quick-sidebar-overlay"></div>').insertAfter(".quick-sidebar");
        }
    });

    // Close quick sidebar on outside click
    $(".wrapper").mouseup(function(e) {
        var sidebar = $(".quick-sidebar");
        if (e.target.className === sidebar.attr("class") || sidebar.has(e.target).length === 0) {
            $("html").removeClass("quick_sidebar_open");
            $(".quick-sidebar-toggler").removeClass("toggled");
            $(".quick-sidebar-overlay").remove();
        }
    });

    // Close quick sidebar on close button click
    $(".close-quick-sidebar").on("click", function() {
        $("html").removeClass("quick_sidebar_open");
        $(".quick-sidebar-toggler").removeClass("toggled");
        $(".quick-sidebar-overlay").remove();
    });
});

// Show or hide sign-in and sign-up containers
var containerSignIn = $(".container-login");
var containerSignUp = $(".container-signup");
var showSignIn = true;
var showSignUp = false;

function changeContainer() {
    containerSignIn.css("display", showSignIn ? "block" : "none");
    containerSignUp.css("display", showSignUp ? "block" : "none");
}

$("#show-signup").on("click", function() {
    showSignUp = true;
    showSignIn = false;
    changeContainer();
});

$("#show-signin").on("click", function() {
    showSignUp = false;
    showSignIn = true;
    changeContainer();
});

changeContainer();

// Form field floating label animation
$(".form-floating-label .form-control").keyup(function() {
    if ($(this).val() !== "") {
        $(this).addClass("filled");
    } else {
        $(this).removeClass("filled");
    }
});

// File input change handler to preview selected image
$('.input-file-image input[type="file"]').change(function() {
    readURL(this);
});

// Toggle password visibility
$(".show-password").on("click", function() {
    showPassword(this);
});
